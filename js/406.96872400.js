"use strict";(self["webpackChunkbrain_web"]=self["webpackChunkbrain_web"]||[]).push([[406],{2442:function(e,t,a){a.r(t),a.d(t,{default:function(){return f}});var s=function(){var e=this,t=e._self._c;return t("div",{staticClass:"custom-body-container"},[t("div",{staticClass:"wrap"},[t("HeaderParams",{attrs:{datasetParams:e.datasetParams},on:{submitParams:e.submitParams}}),t("div",{staticClass:"scatter-container"},[t("div",{staticClass:"params-container"},[t("span",{staticClass:"params-text"},[e._v("Color By")]),t("el-select",{staticClass:"select-space",attrs:{clearable:"",filterable:"","filter-method":e.filterValue,placeholder:"please select color"},on:{change:function(t){return e.switchUmapType(e.colorBy)}},model:{value:e.colorBy,callback:function(t){e.colorBy=t},expression:"colorBy"}},e._l(e.colorByOptions,(function(e){return t("el-option",{key:e["value"],attrs:{label:e["label"],value:e["value"]}})})),1),t("div",{directives:[{name:"loading",rawName:"v-loading",value:e.plotLoadingL,expression:"plotLoadingL"}],staticClass:"left-scatter"},[t("div",{ref:"scatterChartRefLeft",attrs:{id:"scatterChartRefLeft"}})])],1),t("div",{staticClass:"params-container"},[t("span",{staticClass:"params-text"},[e._v("Features")]),t("el-select",{ref:"geneSelect",staticClass:"select-space",attrs:{loading:e.loading,placeholder:"please select gene","filter-method":e.filterValue,clearable:"",filterable:""},on:{change:function(t){return e.switchUmapGene(e.geneFeatures)}},model:{value:e.geneFeatures,callback:function(t){e.geneFeatures=t},expression:"geneFeatures"}},e._l(e.sliceGeneOptions,(function(e){return t("el-option",{key:e["value"],attrs:{label:e["label"],value:e["value"]}})})),1),t("div",{directives:[{name:"loading",rawName:"v-loading",value:e.plotLoadingR,expression:"plotLoadingR"}],staticClass:"right-scatter"},[t("div",{ref:"scatterChartRefRight",attrs:{id:"scatterChartRefRight"}})])],1)])],1)])},l=[],i=(a(8937),a(6361)),r=a.n(i),o=a(9988),n=a(2585),c=JSON.parse('{"Airway":[{"label":"Cell Type","value":"cell_type"},{"label":"Donor ID","value":"donor_ID"},{"label":"Gender","value":"donor_gender"},{"label":"Age","value":"donor_age"},{"label":"Donor Status","value":"donor_status"},{"label":"Region","value":"region"},{"label":"Organ","value":"organ"},{"label":"Sequencing Technology","value":"seq_tech"},{"label":"Sequencing Methods","value":"seq_method"},{"label":"Project Code","value":"project_code"},{"label":"Sample","value":"sample_ID"},{"label":"Level 1","value":"level_1"},{"label":"Level 2","value":"level_2"},{"label":"Level 3","value":"level_3"},{"label":"Level 4","value":"level_4"},{"label":"Level 5","value":"level_5"},{"label":"Study","value":"study_new"}]}'),h=(a(8416),{name:"dataBrowser",components:{HeaderParams:o.A},data(){return{chartInfo:{selectedGroupIndex:-1,selectedGeneGroupIndex:-1},colorBy:"cell_type",geneFeatures:"MAP2",colorByOptions:[],geneOptions:[],datasetParams:{atlas:"Airway",region:"all"},sliceGeneOptions:[],loading:!1,noMore:!1,plotLoadingL:!0,plotLoadingR:!0}},watch:{$route:{handler(e){let{region:t,atlas:a}=e["query"];t&&(this.datasetParams["region"]=t,this.datasetParams["atlas"]=a,"Mouse"===this.datasetParams.atlas?this.geneFeatures="Map2":this.geneFeatures="MAP2",this.colorBy="cell_type",this.getLoadData(this.datasetParams,this.colorBy,this.geneFeatures),this.$set(this,"colorByOptions",c[this.datasetParams["atlas"]]))},immediate:!0,deep:!0}},methods:{filterValue(e){if(""!==e){let t=this.geneOptions.filter((t=>t.value.toLowerCase().indexOf(e.toLowerCase())>-1)),a=t.slice(0,20);this.$set(this,"sliceGeneOptions",a)}else this.sliceGeneOptions=[]},async loadMore(){if(this.loading)return;this.loading=!0;let e=this.geneOptions.slice(this.sliceGeneOptions.length,this.sliceGeneOptions.length+4);this.sliceGeneOptions=this.sliceGeneOptions.concat(e),this.timer=setTimeout((()=>{this.loading=!1}),500),this.geneOptions.length===this.sliceGeneOptions.length&&(this.$refs.geneSelect.$refs.scrollbar.$refs.wrap.removeEventListener("scroll",this.scolling()),this.noMore=!0)},scolling(){let e=this.$refs.geneSelect.$refs.scrollbar.$refs.wrap;if(this.noMore)return;let t=e.scrollHeight-e.scrollTop-5<e.clientHeight;t&&this.loadMore()},async switchUmapGene(e){this.plotLoadingR=!0,this.chartInfo.selectedGeneGroupIndex=-1,await this.getLoadData(this.datasetParams,this.colorBy,e)},async switchUmapType(e){this.plotLoadingL=!0,this.chartInfo.selectedGroupIndex=-1,await this.getLoadData(this.datasetParams,e)},submitParams(e){this.$set(this,"datasetParams",e),"Mouse"===this.datasetParams.atlas?this.geneFeatures="Map2":this.geneFeatures="MAP2",this.$set(this,"colorByOptions",c[e["atlas"]]),this.plotLoadingL=!0,this.plotLoadingR=!0,this.getLoadData(e,this.colorBy,this.geneFeatures)},async getLoadData(e,t,s){let l=await a(2506)(`./${e["atlas"]}_${e["region"]}_umap.json`),i=l.default;const r=this.dealUmapData(i,t,[]);if(this.drawUMAPChart(r,this.$refs.scatterChartRefLeft,"selectedGroupIndex",t),s){let t=await a(6467)(`./${e["atlas"]}/${e["region"]}/${s}.json`),l=t.default,r=l.exps.split(",").map((e=>Number(e)));await this.selectUmapGene(s,i,"cell_type",r)}let o=await a(8061)(`./${e["atlas"]}.json`),n=o.default;this.sliceGeneOptions=n.slice(0,20),this.$set(this,"geneOptions",n),this.plotLoadingL=!1,this.plotLoadingR=!1},async selectUmapGene(e,t,a,s){const l=this.dealUmapData(t,"cell_type",s);this.drawUMAPChart(l,this.$refs.scatterChartRefRight,"selectedGeneGroupIndex",e)},drawUMAPChart(e,t,a,s){const l=document.getElementsByClassName("left-scatter");let i={toImageButtonOptions:{format:"svg",filename:"image",scale:1}},o={legend:{x:0,y:-.04,itemsizing:"constant",orientation:"h",traceorder:"reversed"},margin:{t:50,r:50},aspectratio:{x:1,y:1},hovermode:"closest",width:l[0]?.offsetWidth,height:l[0]?.offsetHeight};r().newPlot(t,e,o,i),t.on("plotly_legendclick",(e=>{const s=e.data.length,l=_.range(s),i=l.filter((e=>e!==this.chartInfo[a]));return e.expandedIndex===this.chartInfo[a]?(r().restyle(t,{opacity:1},i),this.chartInfo[a]=-1):(-1!==this.chartInfo[a]?r().restyle(t,{opacity:.1},[this.chartInfo[a]]):r().restyle(t,{opacity:.1},i),r().restyle(t,{opacity:1},[e.expandedIndex]),this.chartInfo[a]=e.expandedIndex),!1})),window.addEventListener("resize",(()=>{const e=l[0]?.offsetWidth,a=l[0]?.offsetHeight;r().relayout(t,{width:e,height:a})}))},dealUmapData(e,t,a){let s=_.max(a),l=[],i={};if(e.forEach(((e,s)=>{if(i[e[t]])i[e[t]][0].push(e.x),i[e[t]][1].push(e.y),"cell_type"===t&&a.length&&i[e[t]][2].push(a[s]);else{let l=_.get(a,s,null);i[e[t]]=[[e.x],[e.y],[l]]}})),"cell_type"===t&&a.length)for(let n in i)i[n][2].unshift(_.mean(i[n][2]));let r={size:2,symbol:"circle",opacity:1},o={};Object.keys(i).sort().forEach((function(e){o[e]=i[e]}));let c=[],h={};for(let n in o)c.push(n);for(let d=0;d<c.length;d++)h[c[d]]=n.chartColor[d];for(let n in o)a.length&&"cell_type"===t&&(r={color:i[n][2],size:2,cmin:0,cmax:s,colorscale:"Reds"}),l.push({x:i[n][0],y:i[n][1],mode:"markers",type:"scatter",name:n,hovertemplate:i[n][0].map(((e,s)=>"cell_type"===t&&a.length?`Expression: ${i[n][2][s]}<br>x:${e}<br>y:${i[n][1][s]}<br>`:`x:${e}<br>y:${i[n][1][s]}<br>`)),marker:r});return l}},mounted(){this.$refs.geneSelect.$refs.scrollbar.$refs.wrap.addEventListener("scroll",this.scolling),this.getLoadData(this.datasetParams,this.colorBy,this.geneFeatures),this.$set(this,"colorByOptions",c[this.datasetParams["atlas"]])}}),d=h,p=a(6367),u=(0,p.A)(d,s,l,!1,null,null,null),g=u.exports,f=g}}]);